@model List<Message>

@{
	string reciever = "";
	bool isRealUser = false;
}
<div asp-validation-summary="All" class="text-danger"></div>
<div id="messagesContainer" class="border border-dark border-3 overflow-scroll" style="max-height: 400px; max-width: 700px;">

	@foreach (Message message in Model)
	{
		
		<div class="border shadow ms-3 mx-3" style="padding: 1rem;">
		<label class="fw-bold">@message.SendUser.Firstname</label>
		<br />
		<textarea style="width: 70%" readonly>@message.Content</textarea>

			@if (message.ReceiveUser.UserName.Equals(User.Identity.Name))
			{
				@if (message.IsRead == false)
				{
					<form class="d-inline" asp-action="ReadMessage" asp-route-messageID="@message.MessageID" method="post">

						<button class="btn btn-success" type="submit">Läst</button>
					</form>
				}

				
				<button type="button" class="btn btn-danger" onclick="openModal(@message.MessageID)">Ta bort</button>


				<div id="deleteConfirmationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); justify-content: center; align-items: center;">
					<div style="background-color: white; padding: 20px; border-radius: 5px; text-align: center;">
						<p>Är du säker på att du vill ta bort detta meddelande?</p>
						<form id="deleteForm" asp-action="DeleteMessage" method="post">
							<input type="hidden" id="modalMessageID" name="messageID" />
							<button type="submit" class="btn btn-danger">Ja, ta bort</button>
							<button type="button" class="btn btn-secondary" onclick="closeModal()">Nej, avbryt</button>
						</form>
					</div>
				</div>

				<script>
					const modal = document.getElementById("deleteConfirmationModal");
					const messageIDInput = document.getElementById("modalMessageID");

					// Öppna modalen och ställ in meddelande-ID
					function openModal(messageID) {
						messageIDInput.value = messageID;
						modal.style.display = "flex";
					}

					// Stäng modalen
					function closeModal() {
						modal.style.display = "none";
					}

					window.onload = function() {
                        const messagesContainer = document.getElementById("messagesContainer");
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
				</script>

			}
			
		</div>
		<br />

		if (message.SendUser.UserName.Contains("@"))
		{
			isRealUser = true;
		}

		if (message.SendUser.UserName.Equals(User.Identity.Name))
		{
			reciever = message.ReceiverID;
		}
		else
		{
			reciever = message.SenderID;
		}
	}


    
	</div>
	
@if (isRealUser)
{
	<form asp-action="SendMessage" asp-route-recieverID="@reciever" method="post">

		<label>Meddelande</label>
		<br />
		<input id="messageContent" type="text" style="height:100px; width:500px" name="content" value="" />

		<button id="sendMessageButton" type="submit">Skicka</button>

		<script>

			const sendMessageButton = document.getElementById("sendMessageButton");
			const messageContent = document.getElementById("messageContent");
			sendMessageButton.style.display = "none";
			

			messageContent.addEventListener("input", function () {

				const message = messageContent.value.trim();
				
				if (message !== "") {
					sendMessageButton.style.display = "inline-block";
					
				} else {
					sendMessageButton.style.display = "none";
					
				}
			});
		</script>

	</form>

	
}
else
{

	<p>Detta meddelande kommer från en användare utan konto.</p>
	<p>Du kan inte svara på meddelandet.</p>
}
